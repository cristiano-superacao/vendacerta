{% extends "base.html" %}

{% from "_macros/ui.html" import page_header_prescrimed_custom %}

{% block title %}Aprovar OS {{ os.numero_os }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Cabeçalho padronizado -->
    {% call page_header_prescrimed_custom('MANUTENÇÃO') %}
        <h1 class="page-title-clean">
            <i class="bi bi-check-circle-fill me-2"></i>
            Avaliar Ordem de Serviço
        </h1>
        <p class="page-subtitle-clean mb-0">
            OS {{ os.numero_os }} · {{ os.titulo }}
        </p>
        <p class="page-subtitle-clean small text-muted mt-1">
            Defina se esta ordem será aprovada e qual técnico ficará responsável ou registre o motivo da reprovação.
        </p>
    {% endcall %}

    <div class="row g-4">
        <div class="col-lg-8">
            <!-- Informações da OS -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-primary-subtle text-primary border-bottom border-primary-subtle">
                    <h5 class="mb-0">OS {{ os.numero_os }} - {{ os.titulo }}</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Cliente:</strong> {{ os.cliente.nome if os.cliente else '-' }}</p>
                            <p><strong>Prioridade:</strong>
                                {% if os.prioridade == 'urgente' %}
                                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill">Urgente</span>
                                {% elif os.prioridade == 'alta' %}
                                    <span class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill">Alta</span>
                                {% elif os.prioridade == 'normal' %}
                                    <span class="badge bg-info-subtle text-info border border-info-subtle rounded-pill">Normal</span>
                                {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill">Baixa</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Aberta em:</strong> {{ os.data_abertura.strftime('%d/%m/%Y %H:%M') }}</p>
                            <p><strong>Criada por:</strong> {{ os.criada_por.nome if os.criada_por else '-' }}</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Descrição do Problema:</h6>
                    <p>{{ os.descricao_problema }}</p>
                </div>
            </div>

            <!-- Formulário de Aprovação -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 d-flex align-items-center gap-2">
                        <i class="bi bi-person-check text-success"></i>
                        <span>Decisão do Supervisor</span>
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('aprovar_ordem_servico', id=os.id) }}" id="formAprovar">
                        {{ form.hidden_tag() }}

                        <!-- Escolher ação: Aprovar ou Reprovar -->
                        <div class="mb-4">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="acao" id="acaoAprovar" value="aprovar" checked>
                                <label class="btn btn-outline-success" for="acaoAprovar">
                                    <i class="bi bi-check-lg"></i> Aprovar OS
                                </label>

                                <input type="radio" class="btn-check" name="acao" id="acaoReprovar" value="reprovar">
                                <label class="btn btn-outline-danger" for="acaoReprovar">
                                    <i class="bi bi-x-lg"></i> Reprovar OS
                                </label>
                            </div>
                        </div>

                        <!-- Campos de Aprovação -->
                        <div id="camposAprovacao">
                            <div class="mb-3">
                                <label class="form-label">{{ form.tecnico_id.label }} <span class="text-danger">*</span></label>
                                {{ form.tecnico_id(class="form-select" + (" is-invalid" if form.tecnico_id.errors else "")) }}
                                {% if form.tecnico_id.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.tecnico_id.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Selecione o técnico que irá executar esta ordem de serviço</small>
                            </div>
                        </div>

                        <!-- Campos de Reprovação -->
                        <div id="camposReprovacao" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">{{ form.motivo_reprovacao.label }} <span class="text-danger">*</span></label>
                                {{ form.motivo_reprovacao(class="form-control" + (" is-invalid" if form.motivo_reprovacao.errors else ""), rows=4, placeholder="Explique o motivo da reprovação...") }}
                                {% if form.motivo_reprovacao.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.motivo_reprovacao.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Campo hidden para indicar aprovação -->
                        <input type="hidden" name="aprovar" id="inputAprovar" value="True">

                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="submit" class="btn btn-primary" id="btnSubmit">
                                <i class="bi bi-check-lg"></i> <span id="textoBtn">Aprovar e Atribuir Técnico</span>
                            </button>
                            <a href="{{ url_for('visualizar_ordem_servico', id=os.id) }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Voltar para detalhes da OS
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title mb-3"><i class="bi bi-info-circle-fill me-2"></i>Orientações</h6>
                    <hr>
                    <h6>Ao Aprovar:</h6>
                    <ul class="small">
                        <li>A OS será atribuída ao técnico selecionado</li>
                        <li>O técnico poderá iniciar o atendimento</li>
                        <li>Status mudará para "Aprovada"</li>
                    </ul>
                    <hr>
                    <h6>Ao Reprovar:</h6>
                    <ul class="small">
                        <li>A OS será cancelada</li>
                        <li>O motivo será registrado</li>
                        <li>O administrativo será notificado</li>
                    </ul>
                    <hr>
                    <div class="alert alert-warning mb-0">
                        <small><i class="bi bi-exclamation-triangle me-1"></i>Esta ação não pode ser desfeita</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const radioAprovar = document.getElementById('acaoAprovar');
    const radioReprovar = document.getElementById('acaoReprovar');
    const camposAprovacao = document.getElementById('camposAprovacao');
    const camposReprovacao = document.getElementById('camposReprovacao');
    const inputAprovar = document.getElementById('inputAprovar');
    const btnSubmit = document.getElementById('btnSubmit');
    const textoBtn = document.getElementById('textoBtn');

    function atualizarFormulario() {
        if (radioAprovar.checked) {
            camposAprovacao.style.display = 'block';
            camposReprovacao.style.display = 'none';
            inputAprovar.value = 'True';
            btnSubmit.className = 'btn btn-success';
            btnSubmit.innerHTML = '<i class="bi bi-check-lg"></i> <span id="textoBtn">Aprovar e Atribuir Técnico</span>';
        } else {
            camposAprovacao.style.display = 'none';
            camposReprovacao.style.display = 'block';
            inputAprovar.value = 'False';
            btnSubmit.className = 'btn btn-danger';
            btnSubmit.innerHTML = '<i class="bi bi-x-lg"></i> <span id="textoBtn">Reprovar Ordem de Serviço</span>';
        }
    }

    radioAprovar.addEventListener('change', atualizarFormulario);
    radioReprovar.addEventListener('change', atualizarFormulario);

    // Inicializar
    atualizarFormulario();
});
</script>
{% endblock %}
