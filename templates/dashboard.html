{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Metas{% endblock %}

{% block content %}
<!-- Header Padrão Prescrimed -->
<div class="page-header-clean mb-4">
    <p class="page-category">ADMINISTRATIVO</p>
    <h1 class="page-title-clean">Dashboard</h1>
    <p class="page-subtitle-clean">Gestão completa de vendas, metas e comissões em {{ resumo_global.mes }}/{{ resumo_global.ano }}</p>

    <div class="d-flex gap-2 mt-3 flex-wrap">
        {% if current_user.is_super_admin %}
        <a href="{{ url_for('super_admin_empresas') }}" class="btn btn-secondary-clean">
            <i class="bi bi-building"></i>
            <span>Empresas</span>
        </a>
        {% endif %}
        <a href="{{ url_for('lista_metas') }}" class="btn-primary-clean">
            <i class="bi bi-plus-lg"></i>
            <span>Nova Meta</span>
        </a>
        <a href="{{ url_for('exportar_pdf_dashboard') }}" class="btn-primary-clean">
            <i class="bi bi-file-earmark-pdf"></i>
            <span>Exportar PDF</span>
        </a>
    </div>
</div>

<!-- Cards de Estatísticas - Padrão Prescrimed -->
<div class="row g-3 mb-4">
    <!-- Card Total de Vendedores -->
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stats-card-clean stats-card-green h-100">
            <div class="stats-icon-clean stats-icon-green">
                <i class="bi bi-people-fill"></i>
            </div>
            <p class="stats-label-clean">Total de Vendedores</p>
            <h3 class="stats-value-clean">{{ resumo_global.total_vendedores }}</h3>
            <p class="stats-subtitle-clean">Ativos no sistema</p>
        </div>
    </div>

    <!-- Card Receita Total -->
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stats-card-clean stats-card-teal h-100">
            <div class="stats-icon-clean stats-icon-teal">
                <i class="bi bi-currency-dollar"></i>
            </div>
            <p class="stats-label-clean">Receita</p>
            <h3 class="stats-value-clean">{{ resumo_global.total_receita_formatada }}</h3>
            <p class="stats-subtitle-clean positive">{{ "%.1f"|format(resumo_global.alcance_equipe|default(0)) }}% da meta</p>
        </div>
    </div>

    <!-- Card Meta Total -->
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stats-card-clean stats-card-red h-100">
            <div class="stats-icon-clean stats-icon-red">
                <i class="bi bi-bullseye"></i>
            </div>
            <p class="stats-label-clean">Meta do Mês</p>
            <h3 class="stats-value-clean">{{ resumo_global.total_meta_formatada }}</h3>
            <p class="stats-subtitle-clean">Objetivo do período</p>
        </div>
    </div>

    <!-- Card Comissão Total -->
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stats-card-clean stats-card-purple h-100">
            <div class="stats-icon-clean stats-icon-purple">
                <i class="bi bi-wallet2"></i>
            </div>
            <p class="stats-label-clean">Comissão</p>
            <h3 class="stats-value-clean">{{ resumo_global.total_comissao_formatada }}</h3>
            <p class="stats-subtitle-clean">Saldo acumulado</p>
        </div>
    </div>
</div>

<!-- Barra de Progresso - Alcance Geral -->
<div class="card progress-card mb-4">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <p class="progress-title mb-1">Alcance Geral da Equipe</p>
                <p class="progress-subtitle">Progresso até o momento</p>
            </div>
            <div class="progress-percentage {% if resumo_global.alcance_equipe >= 100 %}text-success{% elif resumo_global.alcance_equipe >= 75 %}text-primary{% elif resumo_global.alcance_equipe >= 50 %}text-warning{% else %}text-danger{% endif %}">
                {{ "%.1f"|format(resumo_global.alcance_equipe) }}%
            </div>
        </div>

        <div class="progress-modern mb-3">
            <div class="progress-bar-modern {% if resumo_global.alcance_equipe >= 100 %}bg-success{% elif resumo_global.alcance_equipe >= 75 %}bg-primary{% elif resumo_global.alcance_equipe >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                 style="width: {{ resumo_global.alcance_equipe if resumo_global.alcance_equipe <= 100 else 100 }}%">
            </div>
        </div>

        <div class="progress-info-footer">
            <i class="bi bi-info-circle me-1"></i>
            <span>Baseado na razão entre receita total e meta total da equipe</span>
        </div>
    </div>
</div>

<!-- Cards de Projeção de Vendas -->
<div class="card projection-card mb-4">
    <div class="card-body p-4">
        <h5 class="section-title mb-4">
            <i class="bi bi-graph-up me-2"></i>Projeção de Vendas da Equipe
        </h5>

        <div class="row g-3">
            <!-- Dias Úteis -->
            <div class="col-12 col-md-4">
                <div class="projection-item">
                    <div class="projection-icon bg-primary bg-opacity-10">
                        <i class="bi bi-calendar-check text-primary"></i>
                    </div>
                    <div class="projection-content">
                        <p class="projection-label">Dias Úteis</p>
                        <h4 class="projection-value text-primary">{{ resumo_global.projecao_global.dias_uteis_trabalhados }}</h4>
                        <small class="projection-detail">
                            <span class="badge bg-info bg-opacity-10 text-info">Trabalhados</span>
                            <span class="badge bg-secondary bg-opacity-10 text-secondary ms-1">{{ resumo_global.projecao_global.dias_uteis_restantes }} restantes</span>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Média Diária -->
            <div class="col-12 col-md-4">
                <div class="projection-item">
                    <div class="projection-icon bg-info bg-opacity-10">
                        <i class="bi bi-speedometer text-info"></i>
                    </div>
                    <div class="projection-content">
                        <p class="projection-label">Média Diária</p>
                        <h4 class="projection-value text-info">{{ resumo_global.projecao_global.media_diaria_formatada }}</h4>
                        <small class="projection-detail">Receita média por dia útil</small>
                    </div>
                </div>
            </div>

            <!-- Projeção Final -->
            <div class="col-12 col-md-4">
                <div class="projection-item projection-highlight {% if resumo_global.projecao_global.status_projecao == 'acima' %}projection-success{% else %}projection-warning{% endif %}">
                    <div class="projection-icon {% if resumo_global.projecao_global.status_projecao == 'acima' %}bg-success{% else %}bg-warning{% endif %} bg-opacity-10">
                        <i class="bi bi-trophy {% if resumo_global.projecao_global.status_projecao == 'acima' %}text-success{% else %}text-warning{% endif %}"></i>
                    </div>
                    <div class="projection-content">
                        <p class="projection-label">Projeção Final</p>
                        <h4 class="projection-value {% if resumo_global.projecao_global.status_projecao == 'acima' %}text-success{% else %}text-warning{% endif %}">
                            {{ resumo_global.projecao_global.projecao_mes_formatada }}
                        </h4>
                        <small class="projection-detail {% if resumo_global.projecao_global.status_projecao == 'acima' %}text-success{% else %}text-warning{% endif %}">
                            {{ "%.1f"|format(resumo_global.projecao_global.percentual_projecao) }}% da meta
                            {% if resumo_global.projecao_global.status_projecao == 'acima' %}
                                <i class="bi bi-check-circle-fill ms-1"></i>
                            {% else %}
                                <i class="bi bi-exclamation-triangle-fill ms-1"></i>
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Projeções por Equipe/Mesa -->
{% if projecoes_por_equipe %}
<div class="card projection-card mb-4">
    <div class="card-body p-4">
        <h5 class="section-title mb-4">
            <i class="bi bi-people-fill me-2"></i>Projeções por Equipe/Mesa
        </h5>

        <div class="row g-3">
            {% for equipe in projecoes_por_equipe %}
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card equipe-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="equipe-nome">{{ equipe.nome }}</h6>
                                <small class="text-muted">
                                    <i class="bi bi-person-fill"></i> {{ equipe.vendedores }} vendedor{{ 'es' if equipe.vendedores > 1 else '' }}
                                </small>
                            </div>
                            <div class="equipe-badge {% if equipe.percentual_alcance >= 100 %}bg-success{% elif equipe.percentual_alcance >= 75 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ "%.0f"|format(equipe.percentual_alcance) }}%
                            </div>
                        </div>

                        <div class="equipe-stats mb-3">
                            <div class="stat-row">
                                <span class="stat-label">Receita:</span>
                                <span class="stat-value text-success fw-bold">
                                    R$ {{ "%.2f"|format(equipe.receita_total) | replace(".", ",") | replace(",", ".", 1) }}
                                </span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Meta:</span>
                                <span class="stat-value">
                                    R$ {{ "%.2f"|format(equipe.meta_total) | replace(".", ",") | replace(",", ".", 1) }}
                                </span>
                            </div>
                        </div>

                        <div class="projecao-info">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Projeção Final:</small>
                                <strong class="{% if equipe.projecao.status_projecao == 'acima' %}text-success{% else %}text-warning{% endif %}">
                                    {{ equipe.projecao.projecao_mes_formatada }}
                                </strong>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar {% if equipe.projecao.status_projecao == 'acima' %}bg-success{% else %}bg-warning{% endif %}"
                                     style="width: {{ equipe.projecao.percentual_projecao if equipe.projecao.percentual_projecao <= 100 else 100 }}%">
                                </div>
                            </div>
                            <small class="d-block mt-2 text-muted">
                                <i class="bi bi-speedometer"></i> {{ equipe.projecao.media_diaria_formatada }}/dia
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Projeções por Supervisão -->
{% if projecoes_por_supervisor %}
<div class="card projection-card mb-4">
    <div class="card-body p-4">
        <h5 class="section-title mb-4">
            <i class="bi bi-person-badge-fill me-2"></i>Projeções por Supervisão
        </h5>

        <div class="table-responsive">
            <table class="table table-supervisor">
                <thead>
                    <tr>
                        <th>Supervisor</th>
                        <th class="text-center d-none d-lg-table-cell">Gerente</th>
                        <th class="text-center">Vendedores</th>
                        <th class="text-end">Receita</th>
                        <th class="text-end">Meta</th>
                        <th class="text-end d-none d-xl-table-cell">Meta Supervisionada</th>
                        <th class="text-end" style="width: 150px;">Alcance</th>
                        <th class="text-end d-none d-lg-table-cell">Projeção</th>
                        <th class="text-end">Média/Dia</th>
                        <th class="text-end d-none d-lg-table-cell">Taxa</th>
                        <th class="text-end">Comissão</th>
                    </tr>
                </thead>
                <tbody>
                    {% for supervisor in projecoes_por_supervisor %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="supervisor-avatar">
                                    {{ supervisor.nome[0]|upper }}
                                </div>
                                <strong>{{ supervisor.nome }}</strong>
                            </div>
                        </td>
                        <td class="text-center d-none d-lg-table-cell">
                            <span class="badge bg-info bg-opacity-10 text-info">
                                {{ supervisor.gerente }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-primary bg-opacity-10 text-primary">
                                {{ supervisor.vendedores }}
                            </span>
                        </td>
                        <td class="text-end">
                            <span class="fw-semibold text-success">
                                R$ {{ "%.2f"|format(supervisor.receita_total) | replace(".", ",") | replace(",", ".", 1) }}
                            </span>
                        </td>
                        <td class="text-end">
                            <span class="text-muted">
                                R$ {{ "%.2f"|format(supervisor.meta_total) | replace(".", ",") | replace(",", ".", 1) }}
                            </span>
                        </td>
                        <td class="text-end d-none d-xl-table-cell">
                            <span class="fw-semibold text-primary">
                                R$ {{ "%.2f"|format(supervisor.meta_supervisionada) | replace(".", ",") | replace(",", ".", 1) }}
                            </span>
                        </td>
                        <td class="text-end">
                            <div class="progress" style="height: 24px;">
                                <div class="progress-bar {% if supervisor.percentual_alcance >= 100 %}bg-success{% elif supervisor.percentual_alcance >= 75 %}bg-info{% else %}bg-warning{% endif %}"
                                     style="width: {{ supervisor.percentual_alcance if supervisor.percentual_alcance <= 100 else 100 }}%">
                                    {{ "%.1f"|format(supervisor.percentual_alcance) }}%
                                </div>
                            </div>
                        </td>
                        <td class="text-end d-none d-lg-table-cell">
                            <div>
                                <span class="fw-semibold" style="color: #111827; font-size: 0.9375rem;">
                                    {{ supervisor.projecao.projecao_mes_formatada }}
                                </span>
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                {{ "%.1f"|format(supervisor.projecao.percentual_projecao) }}% projetado
                            </small>
                        </td>
                        <td class="text-end">
                            <span class="fw-semibold" style="color: #0ea5e9; font-size: 0.9375rem;">
                                {{ supervisor.projecao.media_diaria_formatada if supervisor.projecao.media_diaria_formatada else 'R$ 0,00' }}
                            </span>
                        </td>
                        <td class="text-end d-none d-lg-table-cell">
                            <span class="badge bg-info bg-opacity-10 text-info">
                                {{ "{:.1f}".format((supervisor.taxa_supervisor or 0) * 100) }}%
                            </span>
                        </td>
                        <td class="text-end">
                            <span class="fw-semibold text-purple">
                                R$ {{ "{:,.2f}".format(supervisor.comissao_supervisor or 0.0).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Controle de Visualização -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex flex-wrap gap-2 justify-content-center justify-content-md-start">
            <button class="btn btn-primary view-toggle-btn active" data-view="rankings">
                <i class="bi bi-trophy me-2"></i>Rankings
            </button>
            <button class="btn btn-outline-primary view-toggle-btn" data-view="equipes">
                <i class="bi bi-people-fill me-2"></i>Equipes Detalhadas
            </button>
        </div>
    </div>
</div>

<!-- Rankings Lado a Lado -->
<div id="rankings-view" class="row g-4">
    <!-- Ranking de Vendedores -->
    <div class="col-12 col-xl-6">
        <div class="card ranking-card h-100">
            <div class="card-body p-4">
                <h5 class="section-title mb-4">
                    <i class="bi bi-trophy me-2"></i>Ranking de Vendedores
                </h5>

                {% if vendedores %}
                <div class="table-responsive">
                    <table class="table table-modern table-compact">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Vendedor</th>
                                <th class="text-end">Receita</th>
                                <th class="text-end d-none d-xxl-table-cell">Meta</th>
                                <th class="text-end" style="width: 150px;">Alcance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vendedor in vendedores[:10] %}
                            <tr>
                                <td>
                                    <span class="rank-badge-small {% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% else %}rank-other{% endif %}">
                                        {{ loop.index }}
                                    </span>
                                </td>
                                <td>
                                    <div class="vendedor-info-compact">
                                        <span class="vendedor-nome-compact">{{ vendedor.nome }}</span>
                                        <span class="vendedor-supervisor-compact">
                                            <i class="bi bi-person-badge"></i> {{ vendedor.supervisor }}
                                        </span>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <span class="fw-semibold text-success" style="font-size: 0.875rem;">
                                        R$ {{ "%.0f"|format(vendedor.receita_alcancada / 1000) }}k
                                    </span>
                                </td>
                                <td class="text-end d-none d-xxl-table-cell">
                                    <span class="text-muted" style="font-size: 0.875rem;">
                                        R$ {{ "%.0f"|format(vendedor.meta / 1000) }}k
                                    </span>
                                </td>
                                <td class="text-end">
                                    <div class="progress" style="height: 20px;">
                                        <div
                                            class="progress-bar {% if vendedor.percentual_alcance >= 125 %}bg-success{% elif vendedor.percentual_alcance >= 100 %}bg-info{% elif vendedor.percentual_alcance >= 75 %}bg-warning{% else %}bg-danger{% endif %}"
                                            style="width: {{ vendedor.percentual_alcance if vendedor.percentual_alcance <= 150 else 150 }}%">
                                            <small class="fw-semibold">{{ "%.0f"|format(vendedor.percentual_alcance) }}%</small>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state text-center py-5">
                    <i class="bi bi-inbox empty-icon"></i>
                    <p class="empty-message">Nenhum vendedor com metas cadastradas neste período.</p>
                    <a href="{{ url_for('nova_meta') }}" class="btn btn-primary mt-3">
                        <i class="bi bi-plus-circle me-2"></i>Criar Primeira Meta
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ranking de Supervisores -->
    <div class="col-12 col-xl-6">
        <div class="card ranking-card h-100">
            <div class="card-body p-4">
                <h5 class="section-title mb-4">
                    <i class="bi bi-award me-2"></i>Ranking de Supervisores
                </h5>

                {% if projecoes_por_supervisor %}
                <div class="table-responsive">
                    <table class="table table-modern table-compact">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Supervisor</th>
                                <th class="text-end">Receita</th>
                                <th class="text-end d-none d-xxl-table-cell">Meta</th>
                                <th class="text-end" style="width: 150px;">Alcance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for supervisor in projecoes_por_supervisor[:10] %}
                            <tr>
                                <td>
                                    <span class="rank-badge-small {% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% else %}rank-other{% endif %}">
                                        {{ loop.index }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="supervisor-avatar-small">
                                            {{ supervisor.nome[0]|upper }}
                                        </div>
                                        <div class="supervisor-info-compact">
                                            <span class="supervisor-nome-compact">{{ supervisor.nome }}</span>
                                            <span class="supervisor-equipe-compact">
                                                <i class="bi bi-people-fill"></i> {{ supervisor.vendedores }} vendedor{{ 'es' if supervisor.vendedores > 1 else '' }}
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <span class="fw-semibold text-success" style="font-size: 0.875rem;">
                                        R$ {{ "%.0f"|format(supervisor.receita_total / 1000) }}k
                                    </span>
                                </td>
                                <td class="text-end d-none d-xxl-table-cell">
                                    <span class="text-muted" style="font-size: 0.875rem;">
                                        R$ {{ "%.0f"|format(supervisor.meta_total / 1000) }}k
                                    </span>
                                </td>
                                <td class="text-end">
                                    <div class="progress" style="height: 20px;">
                                        <div
                                            class="progress-bar {% if supervisor.percentual_alcance >= 125 %}bg-success{% elif supervisor.percentual_alcance >= 100 %}bg-info{% elif supervisor.percentual_alcance >= 75 %}bg-warning{% else %}bg-danger{% endif %}"
                                            style="width: {{ supervisor.percentual_alcance if supervisor.percentual_alcance <= 150 else 150 }}%">
                                            <small class="fw-semibold">{{ "%.0f"|format(supervisor.percentual_alcance) }}%</small>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state text-center py-5">
                    <i class="bi bi-inbox empty-icon"></i>
                    <p class="empty-message">Nenhum supervisor com vendedores cadastrados.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Ranking de Equipes -->
    <div class="col-12 col-xl-6 ranking-section" data-ranking-type="equipes" style="display: none;">
        <div class="card ranking-card h-100">
            <div class="card-body p-4">
                <h5 class="section-title mb-4">
                    <i class="bi bi-people-fill me-2"></i>Ranking de Equipes
                </h5>

                {% if projecoes_por_equipe %}
                <div class="table-responsive">
                    <table class="table table-modern table-compact">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Equipe</th>
                                <th class="text-end">Receita</th>
                                <th class="text-end d-none d-xxl-table-cell">Meta</th>
                                <th class="text-end" style="width: 150px;">Alcance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for equipe in projecoes_por_equipe[:10] %}
                            <tr>
                                <td>
                                    <span class="rank-badge-small {% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% else %}rank-other{% endif %}">
                                        {{ loop.index }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="equipe-avatar-small">
                                            {{ equipe.nome[0]|upper }}
                                        </div>
                                        <div class="equipe-info-compact">
                                            <span class="equipe-nome-compact">{{ equipe.nome }}</span>
                                            <span class="equipe-vendedores-compact">
                                                <i class="bi bi-person-badge"></i> {{ equipe.vendedores }} vendedor{{ 'es' if equipe.vendedores > 1 else '' }}
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <span class="fw-semibold text-success" style="font-size: 0.875rem;">
                                        R$ {{ "%.0f"|format(equipe.receita_total / 1000) }}k
                                    </span>
                                </td>
                                <td class="text-end d-none d-xxl-table-cell">
                                    <span class="text-muted" style="font-size: 0.875rem;">
                                        R$ {{ "%.0f"|format(equipe.meta_total / 1000) }}k
                                    </span>
                                </td>
                                <td class="text-end">
                                    <div class="progress" style="height: 20px;">
                                        <div
                                            class="progress-bar {% if equipe.percentual_alcance >= 125 %}bg-success{% elif equipe.percentual_alcance >= 100 %}bg-info{% elif equipe.percentual_alcance >= 75 %}bg-warning{% else %}bg-danger{% endif %}"
                                            style="width: {{ equipe.percentual_alcance if equipe.percentual_alcance <= 150 else 150 }}%">
                                            <small class="fw-semibold">{{ "%.0f"|format(equipe.percentual_alcance) }}%</small>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state text-center py-5">
                    <i class="bi bi-inbox empty-icon"></i>
                    <p class="empty-message">Nenhuma equipe com metas cadastradas neste período.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- View de Equipes Detalhadas -->
<div id="equipes-view" class="row g-4" style="display: none;">
    {% if projecoes_por_equipe %}
        {% for equipe in projecoes_por_equipe %}
        <div class="col-12 col-lg-6">
            <div class="card equipe-detail-card">
                <div class="card-header equipe-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-3">
                            <div class="equipe-avatar-large">
                                {{ equipe.nome[0]|upper }}
                            </div>
                            <div>
                                <h5 class="equipe-titulo mb-1">{{ equipe.nome }}</h5>
                                <span class="badge bg-primary bg-opacity-10 text-primary">
                                    <i class="bi bi-people-fill me-1"></i>{{ equipe.vendedores }} vendedor{{ 'es' if equipe.vendedores > 1 else '' }}
                                </span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="equipe-percentual {% if equipe.percentual_alcance >= 100 %}text-success{% elif equipe.percentual_alcance >= 75 %}text-warning{% else %}text-danger{% endif %}">
                                {{ "%.0f"|format(equipe.percentual_alcance) }}%
                            </div>
                            <small class="text-muted">alcance</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <small class="text-muted d-block">Receita</small>
                            <strong class="text-success">R$ {{ "%.2f"|format(equipe.receita_total) | replace(".", ",") | replace(",", ".", 1) }}</strong>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted d-block">Meta</small>
                            <strong class="text-primary">R$ {{ "%.2f"|format(equipe.meta_total) | replace(".", ",") | replace(",", ".", 1) }}</strong>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-equipe-vendedores mb-0">
                            <thead>
                                <tr>
                                    <th>Vendedor</th>
                                    <th class="text-end">Receita</th>
                                    <th class="text-end d-none d-md-table-cell">Meta</th>
                                    <th class="text-end">Alcance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vendedor in vendedores %}
                                    {% if vendedor.equipe_nome == equipe.nome %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="vendedor-avatar-tiny">
                                                    {{ vendedor.nome[0]|upper }}
                                                </div>
                                                <span class="vendedor-nome-small">{{ vendedor.nome }}</span>
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <span class="fw-semibold text-success" style="font-size: 0.875rem;">
                                                R$ {{ "%.0f"|format(vendedor.receita_alcancada / 1000) }}k
                                            </span>
                                        </td>
                                        <td class="text-end d-none d-md-table-cell">
                                            <span class="text-muted" style="font-size: 0.875rem;">
                                                R$ {{ "%.0f"|format(vendedor.meta / 1000) }}k
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge {% if vendedor.percentual_alcance >= 100 %}bg-success{% elif vendedor.percentual_alcance >= 75 %}bg-info{% else %}bg-warning{% endif %}">
                                                {{ "%.0f"|format(vendedor.percentual_alcance) }}%
                                            </span>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="empty-state text-center py-5">
            <i class="bi bi-inbox empty-icon"></i>
            <p class="empty-message">Nenhuma equipe com metas cadastradas neste período.</p>
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Títulos e Cards Base */
.section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
}

.projection-card, .ranking-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
}

/* Projeções */
.projection-item {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.25rem;
    height: 100%;
    transition: all 0.2s ease;
}

.projection-item:hover {
    border-color: #d1d5db;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.projection-highlight { border-width: 2px; }
.projection-success { border-color: #10b981; background: #f0fdf4; }
.projection-warning { border-color: #f59e0b; background: #fffbeb; }

.projection-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    margin-bottom: 0.75rem;
}

.projection-content { flex: 1; }

.projection-label {
    font-size: 0.8125rem;
    font-weight: 500;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-bottom: 0.5rem;
}

.projection-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.projection-detail {
    font-size: 0.75rem;
    color: #6b7280;
}

/* Tabelas */
.table-modern, .table-supervisor {
    font-size: 0.9375rem;
    margin-bottom: 0;
}

.table-modern thead, .table-supervisor thead {
    background: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
}

.table-modern thead th, .table-supervisor thead th {
    font-size: 0.8125rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    padding: 1rem 0.75rem;
    border: none;
}

.table-modern tbody tr, .table-supervisor tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.15s ease;
}

.table-modern tbody tr:hover, .table-supervisor tbody tr:hover {
    background: #f9fafb;
}

.table-modern tbody td, .table-supervisor tbody td {
    padding: 1rem 0.75rem;
    border: none;
    vertical-align: middle;
}

.table-compact {
    font-size: 0.875rem;
}

.table-compact thead th {
    padding: 0.75rem 0.5rem;
    font-size: 0.75rem;
}

.table-compact tbody td {
    padding: 0.75rem 0.5rem;
}

/* Badges de Ranking */
.rank-badge, .rank-badge-small {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-weight: 700;
}

.rank-badge {
    width: 32px;
    height: 32px;
    font-size: 0.875rem;
}

.rank-badge-small {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    font-size: 0.8125rem;
}

.rank-1 {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
}

.rank-2 {
    background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(156, 163, 175, 0.3);
}

.rank-3 {
    background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(234, 88, 12, 0.3);
}

.rank-other {
    background: #f3f4f6;
    color: #6b7280;
}

/* Informações de Vendedores */
.vendedor-info, .vendedor-info-compact {
    display: flex;
    flex-direction: column;
}

.vendedor-info { gap: 0.25rem; }
.vendedor-info-compact { gap: 0.125rem; }

.vendedor-nome {
    font-weight: 600;
    color: #111827;
}

.vendedor-nome-compact {
    font-weight: 600;
    color: #111827;
    font-size: 0.875rem;
    line-height: 1.2;
}

.vendedor-supervisor {
    font-size: 0.8125rem;
    color: #6b7280;
}

.vendedor-supervisor-compact {
    font-size: 0.75rem;
    color: #6b7280;
}

/* Avatares de Supervisor */
.supervisor-avatar, .supervisor-avatar-small {
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
}

.supervisor-avatar {
    width: 36px;
    height: 36px;
    font-size: 0.875rem;
}

.supervisor-avatar-small {
    width: 32px;
    height: 32px;
    min-width: 32px;
    font-size: 0.8125rem;
}

.supervisor-info-compact {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    min-width: 0;
}

.supervisor-nome-compact {
    font-weight: 600;
    color: #111827;
    font-size: 0.875rem;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.supervisor-equipe-compact {
    font-size: 0.75rem;
    color: #6b7280;
}

/* Cards de Equipe */
.equipe-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    transition: all 0.2s ease;
}

.equipe-card:hover {
    border-color: #d1d5db;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.equipe-nome {
    font-size: 1rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
}

.equipe-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 50px;
    padding: 0.375rem 0.75rem;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.875rem;
    color: white;
}

.equipe-stats {
    border-top: 1px solid #f3f4f6;
    border-bottom: 1px solid #f3f4f6;
    padding: 0.75rem 0;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
}

.stat-label {
    font-size: 0.875rem;
    color: #6b7280;
}

.stat-value {
    font-size: 0.875rem;
    color: #111827;
}

.projecao-info {
    padding-top: 0.75rem;
}

/* Filtro de Ranking */
.ranking-filter-btn, .view-toggle-btn {
    border-radius: 8px;
    font-weight: 500;
    padding: 0.5rem 1.25rem;
    transition: all 0.2s ease;
    border: 2px solid #2563eb;
}

.ranking-filter-btn:not(.active), .view-toggle-btn:not(.active) {
    background: white;
    color: #2563eb;
    border-color: #e5e7eb;
}

.ranking-filter-btn:not(.active):hover, .view-toggle-btn:not(.active):hover {
    background: #eff6ff;
    border-color: #2563eb;
    color: #2563eb;
}

.ranking-filter-btn.active, .view-toggle-btn.active {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
}

/* Avatar de Equipe */
.equipe-avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    flex-shrink: 0;
}

.equipe-info-compact {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.equipe-nome-compact {
    font-weight: 600;
    font-size: 0.875rem;
    color: #111827;
    line-height: 1.2;
}

.equipe-vendedores-compact {
    font-size: 0.75rem;
    color: #6b7280;
}

/* Cards de Equipes Detalhadas */
.equipe-detail-card {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.2s ease;
}

.equipe-detail-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.equipe-header {
    background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
    border-bottom: 1px solid #e5e7eb;
    padding: 1.5rem;
}

.equipe-avatar-large {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.equipe-titulo {
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
}

.equipe-percentual {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
}

.table-equipe-vendedores {
    font-size: 0.875rem;
}

.table-equipe-vendedores thead {
    background: #f9fafb;
}

.table-equipe-vendedores thead th {
    font-weight: 600;
    color: #6b7280;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.8125rem;
}

.table-equipe-vendedores tbody td {
    padding: 0.875rem 1rem;
    vertical-align: middle;
    border-bottom: 1px solid #f3f4f6;
}

.table-equipe-vendedores tbody tr:last-child td {
    border-bottom: none;
}

.table-equipe-vendedores tbody tr:hover {
    background: #f9fafb;
}

.vendedor-avatar-tiny {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.75rem;
    flex-shrink: 0;
}

.vendedor-nome-small {
    font-weight: 500;
    color: #111827;
    font-size: 0.875rem;
}

/* Estados e Utilitários */
.empty-state { padding: 3rem 1rem; }

.empty-icon {
    font-size: 4rem;
    color: #d1d5db;
    margin-bottom: 1rem;
}

.empty-message {
    font-size: 1.125rem;
    color: #6b7280;
    margin-bottom: 0;
}

.valor-destaque {
    font-weight: 600;
    font-size: 1rem;
}

.badge-status {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
}

/* Barras de Progresso */
.progress-modern {
    height: 12px;
    background: #f3f4f6;
    border-radius: 99px;
    overflow: hidden;
}

.progress-bar-modern {
    height: 100%;
    border-radius: 99px;
    transition: width 0.3s ease;
}

.progress-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
}

.progress-subtitle {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0;
}

.progress-percentage {
    font-size: 1.5rem;
    font-weight: 700;
}

.progress-info-footer {
    font-size: 0.875rem;
    color: #6b7280;
}

/* Responsividade */
@media (max-width: 992px) {
    .table-modern thead th, .table-modern tbody td,
    .table-supervisor thead th, .table-supervisor tbody td {
        padding: 0.75rem 0.5rem;
    }
}

@media (max-width: 576px) {
    .stats-card-clean { padding: 1rem; }
    .projection-item { padding: 1rem; }
    .projection-value { font-size: 1.25rem; }
    .equipe-card .card-body { padding: 1rem; }
    .equipe-nome { font-size: 0.9375rem; }
    .stat-row { font-size: 0.8125rem; }
}
</style>

<script>
// Alternar entre Rankings e Equipes Detalhadas
document.addEventListener('DOMContentLoaded', function() {
    const viewButtons = document.querySelectorAll('.view-toggle-btn');
    const rankingsView = document.getElementById('rankings-view');
    const equipesView = document.getElementById('equipes-view');

    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const viewType = this.getAttribute('data-view');

            // Atualizar botões ativos
            viewButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // Alternar views
            if (viewType === 'rankings') {
                rankingsView.style.display = 'flex';
                equipesView.style.display = 'none';
            } else if (viewType === 'equipes') {
                rankingsView.style.display = 'none';
                equipesView.style.display = 'flex';

                // Animar entrada
                equipesView.style.opacity = '0';
                setTimeout(() => {
                    equipesView.style.transition = 'opacity 0.3s ease';
                    equipesView.style.opacity = '1';
                }, 10);
            }
        });
    });
});
</script>

{% endblock %}