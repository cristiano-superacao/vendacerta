{% extends "base.html" %}

{% block title %}Dashboard Supervisor - Sistema de Metas{% endblock %}

{% block content %}
<!-- Header Moderno -->
<div class="modern-header mb-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <p class="text-muted text-uppercase small mb-1 fw-semibold" style="letter-spacing: 1px;">DASHBOARD SUPERVISOR</p>
            <h1 class="page-title-modern mb-2">
                <i class="bi bi-diagram-3"></i> Painel de Gestão de Equipe
            </h1>
            <p class="text-muted mb-0">Acompanhe metas, projeções e desempenho dos seus vendedores.</p>
        </div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Dashboard Geral
            </a>
            <a href="{{ url_for('lista_vendedores') }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-people"></i> Meus Vendedores
            </a>
            <div class="badge bg-primary fs-6 px-3 py-2">
                <i class="bi bi-calendar3"></i> {{ mes_atual }}/{{ ano_atual }}
            </div>
        </div>
    </div>
</div>

{% if resumo_supervisor and vendedores_data %}
<!-- Cards de Resumo do Supervisor - Estilo Moderno -->
<div class="row g-4 mb-4">
    <!-- Card Total de Vendedores -->
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card-modern border-start border-4 border-success shadow-sm hover-lift">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="icon-modern bg-success bg-opacity-10 text-success">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <span class="badge bg-success bg-opacity-10 text-success">EQUIPE</span>
                </div>
                <h2 class="stats-value-modern mb-1">{{ resumo_supervisor.total_vendedores }}</h2>
                <p class="stats-label-modern mb-0">Vendedores Ativos</p>
            </div>
        </div>
    </div>

    <!-- Card Meta Consolidada -->
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card-modern border-start border-4 border-warning shadow-sm hover-lift">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="icon-modern bg-warning bg-opacity-10 text-warning">
                        <i class="bi bi-bullseye"></i>
                    </div>
                    <span class="badge bg-warning bg-opacity-10 text-warning">META</span>
                </div>
                <h2 class="stats-value-modern mb-1">{{ resumo_supervisor.total_meta_formatada }}</h2>
                <p class="stats-label-modern mb-0">Meta Consolidada</p>
                <small class="text-muted">Soma das metas da equipe</small>
            </div>
        </div>
    </div>

    <!-- Card Receita Consolidada -->
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card-modern border-start border-4 border-primary shadow-sm hover-lift">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="icon-modern bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                    <span class="badge bg-primary bg-opacity-10 text-primary">ALCANÇADO</span>
                </div>
                <h2 class="stats-value-modern mb-1">{{ resumo_supervisor.total_receita_formatada }}</h2>
                <p class="stats-label-modern mb-0">Receita Consolidada</p>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar bg-primary" role="progressbar"
                         style="width: {{ resumo_supervisor.percentual_alcance }}%"
                         aria-valuenow="{{ resumo_supervisor.percentual_alcance }}"
                         aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
                <small class="text-muted">{{ "%.2f"|format(resumo_supervisor.percentual_alcance) }}% da meta</small>
            </div>
        </div>
    </div>

    <!-- Card Comissão Total -->
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card-modern border-start border-4 border-purple shadow-sm hover-lift">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="icon-modern bg-purple bg-opacity-10 text-purple">
                        <i class="bi bi-wallet2"></i>
                    </div>
                    <span class="badge bg-purple bg-opacity-10 text-purple">COMISSÃO</span>
                </div>
                <h2 class="stats-value-modern mb-1">{{ resumo_supervisor.total_comissao_formatada }}</h2>
                <p class="stats-label-modern mb-0">Comissão da Equipe</p>
            </div>
        </div>
    </div>

    <!-- Card Comissão do Supervisor (interligada às faixas) -->
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card-modern border-start border-4 border-info shadow-sm hover-lift">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="icon-modern bg-info bg-opacity-10 text-info">
                        <i class="bi bi-person-badge"></i>
                    </div>
                    <span class="badge bg-info bg-opacity-10 text-info">SUPERVISOR</span>
                </div>
                <h2 class="stats-value-modern mb-1">{{ resumo_supervisor.comissao_supervisor_formatada }}</h2>
                <p class="stats-label-modern mb-0">Comissão do Supervisor</p>
                <small class="text-muted">Taxa aplicada: {{ "{:.1f}".format((resumo_supervisor.taxa_supervisor or 0) * 100) }}%</small>
            </div>
        </div>
    </div>
</div>

<!-- Legenda de Faixas de Comissão do Supervisor (dinâmica) -->
<div class="card mt-2 border-0 shadow-sm">
    <div class="card-body">
        <h5 class="card-title mb-3"><i class="bi bi-info-circle"></i> Faixas de Comissão do Supervisor</h5>
        <div class="row g-2">
            {% if faixas_supervisor %}
                {% for faixa in faixas_supervisor %}
                <div class="col-md-6 col-lg-4">
                    <div class="d-flex align-items-center gap-2">
                        <div class="progress flex-grow-1 progress-sm" style="height: 20px;">
                            <div class="progress-bar bg-{{ faixa.cor }} w-100 d-flex align-items-center justify-content-center">
                                {% if faixa.alcance_max is none or faixa.alcance_max >= 1000 %}
                                    <i class="bi bi-star-fill text-white me-1" style="font-size: 0.7rem;"></i> Acima de {{ '{:.0f}'.format(faixa.alcance_min) }}%
                                {% else %}
                                    <i class="bi bi-circle-fill text-white me-1" style="font-size: 0.7rem;"></i> {{ '{:.0f}'.format(faixa.alcance_min) }}-{{ '{:.0f}'.format(faixa.alcance_max) }}%
                                {% endif %}
                            </div>
                        </div>
                        <span class="text-muted small fw-bold">{{ '{:.1f}'.format(faixa.taxa_comissao * 100) }}%</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-muted small">Nenhuma faixa configurada. Configure em Configurações → Faixas de Comissão.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Card de Projeção Consolidada -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-gradient-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-graph-up"></i> Projeção Consolidada da Equipe
        </h5>
    </div>
    <div class="card-body p-4">
        <div class="row g-4">
            <!-- Média Diária -->
            <div class="col-md-3">
                <div class="info-card text-center">
                    <i class="bi bi-calendar-day text-info" style="font-size: 2rem;"></i>
                    <h5 class="mt-2 mb-1">{{ resumo_supervisor.projecao.media_diaria_formatada }}</h5>
                    <p class="text-muted mb-0 small">Média Diária</p>
                </div>
            </div>

            <!-- Projeção do Mês -->
            <div class="col-md-3">
                <div class="info-card text-center">
                    <i class="bi bi-graph-up-arrow text-primary" style="font-size: 2rem;"></i>
                    <h5 class="mt-2 mb-1">{{ resumo_supervisor.projecao.projecao_mes_formatada }}</h5>
                    <p class="text-muted mb-0 small">Projeção do Mês</p>
                </div>
            </div>

            <!-- Percentual de Projeção -->
            <div class="col-md-3">
                <div class="info-card text-center">
                    <i class="bi bi-percent text-success" style="font-size: 2rem;"></i>
                    <h5 class="mt-2 mb-1">{{ "%.1f"|format(resumo_supervisor.projecao.percentual_projecao) }}%</h5>
                    <p class="text-muted mb-0 small">% da Meta Projetado</p>
                </div>
            </div>

            <!-- Status da Projeção -->
            <div class="col-md-3">
                <div class="info-card text-center">
                    {% if resumo_supervisor.projecao.status_projecao == 'acima' %}
                        <i class="bi bi-emoji-smile text-success" style="font-size: 2rem;"></i>
                        <h5 class="mt-2 mb-1 text-success">Acima</h5>
                    {% elif resumo_supervisor.projecao.status_projecao == 'dentro' %}
                        <i class="bi bi-emoji-neutral text-warning" style="font-size: 2rem;"></i>
                        <h5 class="mt-2 mb-1 text-warning">No Limite</h5>
                    {% else %}
                        <i class="bi bi-emoji-frown text-danger" style="font-size: 2rem;"></i>
                        <h5 class="mt-2 mb-1 text-danger">Abaixo</h5>
                    {% endif %}
                    <p class="text-muted mb-0 small">Status da Projeção</p>
                </div>
            </div>
        </div>

        <!-- Informações Adicionais -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i>
                    <strong>Dias Úteis:</strong>
                    {{ resumo_supervisor.projecao.dias_uteis_trabalhados }} trabalhados de {{ resumo_supervisor.projecao.dias_uteis_total }}
                    ({{ resumo_supervisor.projecao.dias_uteis_restantes }} restantes)
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Meta Diária Necessária:</strong>
                    {{ resumo_supervisor.projecao.meta_diaria_necessaria_formatada }}
                    para atingir meta
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Vendedores -->
<div class="card shadow-sm border-0">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="bi bi-table"></i> Desempenho Individual dos Vendedores
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">#</th>
                        <th>Vendedor</th>
                        <th class="text-end">Meta</th>
                        <th class="text-end">Receita</th>
                        <th class="text-center">Alcance</th>
                        <th class="text-end">Projeção</th>
                        <th class="text-center">Status Projeção</th>
                        <th class="text-end">Comissão</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vendedor in vendedores_data %}
                    <tr>
                        <td class="text-center fw-bold">{{ loop.index }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-initial rounded-circle bg-primary text-white me-2"
                                     style="width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
                                    {{ vendedor.nome[0].upper() }}
                                </div>
                                <div>
                                    <div class="fw-semibold">{{ vendedor.nome }}</div>
                                    <small class="text-muted">{{ vendedor.email }}</small>
                                </div>
                            </div>
                        </td>
                        <td class="text-end">R$ {{ "{:,.2f}".format(vendedor.meta).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                        <td class="text-end fw-semibold">R$ {{ "{:,.2f}".format(vendedor.receita_alcancada).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                        <td class="text-center">
                            <div class="progress" style="height: 20px; min-width: 100px;">
                                {% set alcance_pct = vendedor.percentual_alcance %}
                                {% if alcance_pct >= 100 %}
                                    <div class="progress-bar bg-success" role="progressbar"
                                         style="width: 100%"
                                         aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                        {{ "%.1f"|format(alcance_pct) }}%
                                    </div>
                                {% elif alcance_pct >= 80 %}
                                    <div class="progress-bar bg-warning" role="progressbar"
                                         style="width: {{ alcance_pct }}%"
                                         aria-valuenow="{{ alcance_pct }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ "%.1f"|format(alcance_pct) }}%
                                    </div>
                                {% else %}
                                    <div class="progress-bar bg-danger" role="progressbar"
                                         style="width: {{ alcance_pct if alcance_pct > 10 else 10 }}%"
                                         aria-valuenow="{{ alcance_pct }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ "%.1f"|format(alcance_pct) }}%
                                    </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-end">
                            <strong>{{ vendedor.projecao.projecao_mes_formatada }}</strong><br>
                            <small class="text-muted">{{ "%.1f"|format(vendedor.projecao.percentual_projecao) }}% da meta</small>
                        </td>
                        <td class="text-center">
                            {% if vendedor.projecao.status_projecao == 'acima' %}
                                <span class="badge bg-success">
                                    <i class="bi bi-arrow-up"></i> Acima
                                </span>
                            {% elif vendedor.projecao.status_projecao == 'dentro' %}
                                <span class="badge bg-warning">
                                    <i class="bi bi-dash"></i> No Limite
                                </span>
                            {% else %}
                                <span class="badge bg-danger">
                                    <i class="bi bi-arrow-down"></i> Abaixo
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-end">R$ {{ "{:,.2f}".format(vendedor.comissao_total).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                        <td class="text-center">
                            {% if vendedor.status_comissao == 'Aprovado' %}
                                <span class="badge bg-success">Aprovado</span>
                            {% elif vendedor.status_comissao == 'Pago' %}
                                <span class="badge bg-info">Pago</span>
                            {% else %}
                                <span class="badge bg-warning">Pendente</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% else %}
<!-- Mensagem quando não há vendedores -->
<div class="alert alert-info text-center py-5">
    <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
    <h4 class="mt-3">Nenhum vendedor vinculado</h4>
    <p class="mb-4">Você ainda não possui vendedores vinculados à sua supervisão para o período {{ mes_atual }}/{{ ano_atual }}.</p>
    <a href="{{ url_for('lista_vendedores') }}" class="btn btn-primary">
        <i class="bi bi-people"></i> Ver Vendedores
    </a>
</div>
{% endif %}

{% endblock %}
