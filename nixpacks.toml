# Configuração Otimizada para Railway/Nixpacks (Python + Venv)
# Resolve erros de PEP 668, pip not found e bibliotecas C++
# Usa wheels manylinux para pandas/numpy (sem compilação)

[phases.setup]
nixPkgs = [
    "python311",
    "python311Packages.pip",
    "postgresql_16",
    "stdenv.cc.cc.lib",
    "gcc",
    "zlib",
    "libjpeg",
    "freetype",
    "lcms2",
    "libwebp",
    "libtiff",
    "openblas",
    "gfortran"
]

[phases.install]
cmds = [
    "python3 -m venv .venv",
    ". .venv/bin/activate && pip install --upgrade pip setuptools wheel",
    ". .venv/bin/activate && pip install --only-binary=:all: --no-cache-dir \"pandas==2.1.4\" \"numpy==1.26.4\" \"openpyxl==3.1.5\" || pip install --no-cache-dir \"pandas==2.1.4\" \"numpy==1.26.4\" \"openpyxl==3.1.5\"",
    ". .venv/bin/activate && pip install --no-cache-dir -r requirements.txt"
]

[phases.build]
dependsOn = ["install"]
cmds = [". .venv/bin/activate && python init_railway.py"]

[start]
cmd = "export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(find /nix/store -name libstdc++.so.6 -printf '%h\n' 2>/dev/null | head -n 1) && . .venv/bin/activate && gunicorn wsgi:app --bind 0.0.0.0:$PORT --workers 2 --threads 4 --timeout 120 --keep-alive 5 --log-level info --access-logfile - --error-logfile - --preload"
