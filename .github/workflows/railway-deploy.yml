name: Deploy to Railway

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Railway Login (Token)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "RAILWAY_TOKEN não configurado como secret. Configure em Settings > Secrets and variables > Actions." && exit 1
          fi
          railway login --token "$RAILWAY_TOKEN"

      - name: Link Railway Project
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
            echo "RAILWAY_PROJECT_ID não configurado como secret. Configure em Settings > Secrets and variables > Actions." && exit 1
          fi
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}

      - name: Atualizar Banco (faixas/técnicos)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Executando atualização de schema no banco (manutenção/técnicos)..."
          railway run python atualizar_banco_railway.py || {
            echo "[AVISO] Falha ao atualizar banco via script. Prosseguindo com deploy.";
          }

      - name: Deploy (railway up)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up

      - name: Verificar Healthcheck (/ping)
        run: |
          URL="${{ vars.HEALTHCHECK_URL }}"
          if [ -z "$URL" ]; then
            URL="https://metacerta.up.railway.app/ping"
          fi
          echo "Verificando saúde em $URL"
          for i in 1 2 3 4 5; do
            if curl -fsS "$URL"; then
              echo "Healthcheck OK"; exit 0;
            fi
            echo "Tentativa $i falhou, aguardando..."; sleep 10;
          done
          echo "Healthcheck falhou"; exit 1

      - name: Print Healthcheck Info
        run: |
          echo "Healthcheck configurado em /ping via railway.json"
